<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOEIC Master Vibe</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="icon" type="image/png" href="https://via.placeholder.com/512/4c51bf/ffffff?text=TOEIC">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/512/4c51bf/ffffff?text=TOEIC">

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body { 
            background-color: #f8fafc; 
            font-family: 'Pretendard', sans-serif; 
            -webkit-user-select: none; 
            user-select: none; 
            touch-action: manipulation;
        }

        .quiz-container { 
            background: white; 
            min-height: 100vh; 
            width: 100%; 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 1.5rem; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 20px rgba(0,0,0,0.02);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-option { 
            width: 100%; 
            text-align: left; 
            padding: 18px; 
            margin-bottom: 12px; 
            border: 2px solid #f1f4f8; 
            border-radius: 20px; 
            background: white; 
            font-weight: 600; 
            font-size: 1rem; 
            transition: all 0.2s ease; 
        }
        .btn-option:active { 
            background-color: #eef2ff; 
            transform: scale(0.98); 
            border-color: #4c51bf; 
        }

        .mode-card { 
            cursor: pointer; 
            border: 2px solid #edf2f7; 
            border-radius: 24px; 
            padding: 1.5rem; 
            transition: 0.3s; 
            text-align: center; 
            height: 100%; 
        }
        .mode-card:active { 
            border-color: #4c51bf; 
            background-color: #f8faff; 
        }

        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .progress-bar-custom { 
            height: 6px; 
            background-color: #edf2f7; 
            border-radius: 10px; 
            margin-bottom: 1.5rem; 
            overflow: hidden;
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #4c51bf, #6366f1); 
            border-radius: 10px; 
            transition: width 0.3s ease; 
        }

        /* ë‹¨ì–´ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .voca-badge { 
            background: #f1f5f9; 
            color: #475569; 
            padding: 4px 10px; 
            border-radius: 8px; 
            font-size: 0.8rem; 
            margin-right: 6px; 
            display: inline-block; 
            margin-top: 6px; 
            font-weight: 600; 
            border: 1px solid #e2e8f0;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="quiz-container">
        <div id="start-screen" class="my-auto">
            <div class="text-center mb-5">
                <span style="font-size: 4rem;">ğŸ¯</span>
                <h2 class="fw-bold mt-3">í† ìµ 700ì  ì±Œë¦°ì§€</h2>
                <p class="text-muted small">Daily RC & LC Study Partner</p>
            </div>
            
            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="mode-card shadow-sm" onclick="startQuiz('RC')">
                        <div class="h3 mb-2">ğŸ“–</div>
                        <h6 class="fw-bold mb-0">RC ë…í•´</h6>
                    </div>
                </div>
                <div class="col-6">
                    <div class="mode-card shadow-sm" onclick="startQuiz('LC')">
                        <div class="h3 mb-2">ğŸ§</div>
                        <h6 class="fw-bold mb-0">LC ë“£ê¸°</h6>
                    </div>
                </div>
                <div class="col-12">
                    <div class="mode-card border-danger shadow-sm" style="background:#fff5f5" onclick="startWrongMode()">
                        <div class="d-flex justify-content-center align-items-center">
                            <span class="me-2 text-danger">ğŸ”¥</span>
                            <h6 class="fw-bold mb-0 text-danger">ì˜¤ë‹µ ë…¸íŠ¸ ë³µìŠµ (<span id="wrong-count">0</span>)</h6>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-light rounded-4 mb-3 text-start">
                <p class="text-muted mb-1" style="font-size: 0.7rem;">ë‚˜ì˜ í•™ìŠµ í†µê³„</p>
                <div id="stat-info" class="fw-bold small text-dark tracking-tight">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
            
            <div class="text-center">
                <button onclick="resetHistory()" class="btn btn-link text-muted text-decoration-none btn-sm" style="font-size: 0.7rem;">ê¸°ë¡ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div id="quiz-content" style="display:none;">
            <div class="progress-bar-custom"><div id="progress-fill" class="progress-fill" style="width: 0%"></div></div>
            <div id="lc-ui" style="display:none;" class="mb-4">
                <button onclick="playCurrentAudio()" class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow-sm" style="background: #4c51bf; border:none;">
                    ğŸ”Š ë¬¸ì œ ë‹¤ì‹œ ë“£ê¸°
                </button>
            </div>
            <h5 id="question" class="fw-bold mb-5" style="line-height: 1.6; word-break: keep-all; color: #1e293b;"></h5>
            <div id="options" class="mb-4"></div>
        </div>

        <div id="result-screen" style="display:none;" class="py-2">
            <div class="text-center mb-4">
                <h3 class="fw-bold mb-1">í•™ìŠµ ê²°ê³¼</h3>
                <div id="score-text" class="display-5 fw-black text-primary mb-2"></div>
                <p id="result-msg" class="text-muted small"></p>
            </div>
            
            <div id="review-section" class="overflow-auto pe-1 custom-scroll" style="max-height: 450px;"></div>
            
            <button onclick="location.reload()" class="btn btn-dark w-100 py-3 rounded-4 fw-bold mt-4 shadow">ëŒ€ì‹œë³´ë“œë¡œ ê°€ê¸°</button>
        </div>
    </div>

    <script>
        let dataRC = [];
        let dataLC = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let userAnswers = [];
        let currentMode = 'RC';

        // 1. JSON ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadAllQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) throw new Error('Data load failed');
                const data = await response.json();
                dataRC = data.rc;
                dataLC = data.lc;
                updateDashboard();
            } catch (error) {
                console.error(error);
                document.getElementById('stat-info').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Live Server í™•ì¸)";
            }
        }

        // 2. í†µê³„ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            const history = JSON.parse(localStorage.getItem('toeic_history') || '[]');
            const wrongPool = JSON.parse(localStorage.getItem('toeic_wrong_pool') || '[]');
            const total = history.length;
            const avg = total > 0 ? (history.reduce((a, b) => a + b.score, 0) / total).toFixed(1) : 0;
            document.getElementById('stat-info').innerText = total > 0 ? `ì´ ${total}íšŒ ì™„ë£Œ | í‰ê·  ${avg}ì ` : "ë°˜ê°€ì›Œìš”! í€´ì¦ˆë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.";
            document.getElementById('wrong-count').innerText = wrongPool.length;
        }

        // 3. í€´ì¦ˆ ì‹œì‘
        function startQuiz(mode) {
            if (dataRC.length === 0) return alert("ë°ì´í„° ë¡œë”© ì¤‘...");
            currentMode = mode;
            const bank = mode === 'RC' ? dataRC : dataLC;
            currentQuestions = shuffle([...bank]).slice(0, 5);
            initUI();
        }

        function startWrongMode() {
            const pool = JSON.parse(localStorage.getItem('toeic_wrong_pool') || '[]');
            if (pool.length === 0) return alert("ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!");
            currentMode = 'WRONG';
            currentQuestions = shuffle([...pool]).slice(0, 5);
            initUI();
        }

        function initUI() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';
            currentIndex = 0; score = 0; userAnswers = [];
            showQuestion();
        }

        // 4. ë¬¸ì œ í‘œì‹œ
        function showQuestion() {
            const q = currentQuestions[currentIndex];
            const isLC = currentMode === 'LC' || (currentMode === 'WRONG' && q.id >= 100);
            document.getElementById('progress-fill').style.width = `${((currentIndex + 1) / 5) * 100}%`;
            document.getElementById('lc-ui').style.display = isLC ? 'block' : 'none';
            document.getElementById('question').innerText = isLC ? "ğŸ”Š ì˜ ë“£ê³  ë‹µì„ ê³ ë¥´ì„¸ìš”." : q.q;
            if (isLC) playCurrentAudio();
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = '';
            q.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "btn-option shadow-sm";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(idx);
                optDiv.appendChild(btn);
            });
        }

        function playCurrentAudio() {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(currentQuestions[currentIndex].q);
            u.lang = 'en-US'; u.rate = 0.85;
            window.speechSynthesis.speak(u);
        }

        // 5. ì •ë‹µ í™•ì¸ ë° ì˜¤ë‹µ ì €ì¥
        function checkAnswer(idx) {
            const q = currentQuestions[currentIndex];
            userAnswers.push(idx);
            if (idx === q.correct) {
                score++;
                manageWrong(q.id, 'REMOVE');
            } else {
                manageWrong(q, 'ADD');
            }
            currentIndex++;
            if (currentIndex < 5) showQuestion(); else showResult();
        }

        function manageWrong(data, action) {
            let pool = JSON.parse(localStorage.getItem('toeic_wrong_pool') || '[]');
            if (action === 'ADD') {
                if (!pool.find(x => x.id === data.id)) pool.push(data);
            } else {
                pool = pool.filter(x => x.id !== data);
            }
            localStorage.setItem('toeic_wrong_pool', JSON.stringify(pool));
        }

        // 6. ê²°ê³¼ ë¦¬í¬íŠ¸ (ë‹¨ì–´ ëœ» í‘œì‹œ ê°•í™”)
        function showResult() {
            const history = JSON.parse(localStorage.getItem('toeic_history') || '[]');
            history.push({ date: new Date().toLocaleDateString(), score: score });
            localStorage.setItem('toeic_history', JSON.stringify(history));

            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('score-text').innerText = `${score} / 5`;
            document.getElementById('result-msg').innerText = score === 5 ? "ì™„ë²½í•©ë‹ˆë‹¤! 700ì ì€ í†µê³¼ë„¤ìš”! ğŸŠ" : "í‹€ë¦° ë‹¨ì–´ë¥¼ ê¼­ í™•ì¸í•˜ì„¸ìš”! ğŸ’ª";

            const rev = document.getElementById('review-section');
            rev.innerHTML = '<h6 class="fw-bold mb-3 text-secondary border-bottom pb-2">ì‹¬ì¸µ ë¶„ì„ ë° ë‹¨ì–´ì¥</h6>';
            
            currentQuestions.forEach((q, i) => {
                const isCorrect = userAnswers[i] === q.correct;
                const vocaEntries = Object.entries(q.voca);
                const vocaHtml = vocaEntries.length > 0 
                    ? `<div class="mt-3 p-2 rounded-3" style="background: rgba(0,0,0,0.03)">
                         <div class="fw-bold mb-1" style="font-size: 0.75rem; color: #6366f1;">ğŸ“Œ í•„ìˆ˜ ì•”ê¸° ë‹¨ì–´</div>
                         ${vocaEntries.map(([k, v]) => `<span class="voca-badge">${k}: ${v}</span>`).join('')}
                       </div>` : '';
                
                rev.innerHTML += `
                    <div class="p-3 mb-3 rounded-4 border ${isCorrect ? 'bg-success-light' : 'bg-danger-light'}" 
                         style="background-color: ${isCorrect ? '#f0fff4' : '#fff5f5'}">
                        <div class="fw-bold small mb-2 text-dark">${q.q}</div>
                        <div class="small mb-3 ${isCorrect ? 'text-success' : 'text-danger'} fw-bold">
                            ì •ë‹µ: ${q.a[q.correct]} ${!isCorrect ? `| ì„ íƒ: ${q.a[userAnswers[i]]}` : ''}
                        </div>
                        <div class="bg-white p-3 rounded-3 border-0 shadow-sm" style="font-size:0.85rem">
                            <div class="mb-1 text-primary fw-bold">í•´ì„</div>
                            <div class="text-secondary mb-2">${q.trans}</div>
                            <div class="mb-1 text-indigo fw-bold" style="color:#4c51bf">í•´ì„¤</div>
                            <div class="text-secondary small">${q.exp}</div>
                            ${vocaHtml}
                        </div>
                    </div>`;
            });
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function resetHistory() {
            if (confirm("ëª¨ë“  ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) { localStorage.clear(); location.reload(); }
        }

        window.onload = loadAllQuestions;
    </script>
</body>
</html>