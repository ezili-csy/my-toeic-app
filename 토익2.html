<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOEIC Vibe - Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/512/4c51bf/ffffff?text=TOEIC">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f8fafc; font-family: 'Pretendard', sans-serif; -webkit-user-select: none; user-select: none; }
        .quiz-container { background: white; min-height: 100vh; width: 100%; max-width: 500px; margin: 0 auto; padding: 1.5rem; display: flex; flex-direction: column; }
        .btn-option { width: 100%; text-align: left; padding: 20px; margin-bottom: 12px; border: 2px solid #f1f4f8; border-radius: 20px; background: white; font-weight: 600; font-size: 1.1rem; }
        .btn-option:active { background-color: #eef2ff; transform: scale(0.98); }
        .mode-card { cursor: pointer; border: 2px solid #edf2f7; border-radius: 24px; padding: 1.5rem; transition: 0.3s; text-align: center; }
        .mode-card.wrong-mode { border-color: #f87171; background-color: #fef2f2; }
        .progress-bar-custom { height: 6px; background-color: #edf2f7; border-radius: 10px; margin-bottom: 1.5rem; }
        .progress-fill { height: 100%; background: #4c51bf; border-radius: 10px; transition: width 0.3s; }
        .voca-badge { background: #e2e8f0; color: #475569; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; margin-right: 4px; display: inline-block; margin-top: 4px; }
    </style>
</head>
<body>

    <div class="quiz-container">
        <div id="start-screen" class="my-auto">
            <h2 class="fw-bold mb-4 text-center">í† ìµ í•™ìŠµ ëŒ€ì‹œë³´ë“œ</h2>
            
            <div class="row g-3 mb-4">
                <div class="col-6"><div class="mode-card" onclick="startQuiz('RC')"><div class="h3 mb-1">ğŸ“–</div><h6 class="fw-bold">RC ë…í•´</h6></div></div>
                <div class="col-6"><div class="mode-card" onclick="startQuiz('LC')"><div class="h3 mb-1">ğŸ§</div><h6 class="fw-bold">LC ë“£ê¸°</h6></div></div>
                <div class="col-12">
                    <div class="mode-card wrong-mode" onclick="startWrongMode()">
                        <div class="d-flex justify-content-center align-items-center">
                            <span class="h4 mb-0 me-2">ğŸ”¥</span>
                            <h6 class="fw-bold mb-0">í‹€ë¦° ë¬¸ì œë§Œ ë‹¤ì‹œ í’€ê¸° (<span id="wrong-count">0</span>)</h6>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-light rounded-4 mb-3">
                <p class="small text-muted mb-1">ëˆ„ì  í•™ìŠµ ê¸°ë¡</p>
                <div id="stat-info" class="fw-bold small text-dark">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div class="text-center">
                <button onclick="resetHistory()" class="btn btn-link text-muted text-decoration-none btn-sm">ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div id="quiz-content" style="display:none;">
            <div class="progress-bar-custom"><div id="progress-fill" class="progress-fill"></div></div>
            <div id="lc-ui" style="display:none;" class="mb-4">
                <button onclick="playCurrentAudio()" class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow-sm">ğŸ”Š ë¬¸ì œ ë‹¤ì‹œ ë“£ê¸°</button>
            </div>
            <h4 id="question" class="fw-bold mb-5" style="line-height: 1.5;"></h4>
            <div id="options"></div>
        </div>

        <div id="result-screen" style="display:none;" class="py-3">
            <h3 class="fw-bold text-center mb-4">ê²°ê³¼ ë¦¬í¬íŠ¸</h3>
            <div id="score-text" class="display-5 fw-black text-center text-primary mb-4"></div>
            <div id="review-section" class="overflow-auto pe-1" style="max-height: 400px;"></div>
            <button onclick="location.reload()" class="btn btn-dark w-100 py-3 rounded-4 fw-bold mt-4">ë©”ì¸ìœ¼ë¡œ</button>
        </div>
    </div>

    <script>
        const rcBank = [
            { id: 1, q: "The manager _______ the proposal yesterday.", a: ["accept", "accepting", "accepted", "accepts"], correct: 2, trans: "ë§¤ë‹ˆì €ëŠ” ì–´ì œ ê·¸ ì œì•ˆì„ ìˆ˜ë½í–ˆë‹¤.", exp: "ê³¼ê±° ì‹œì œ ë¬¸ì œì…ë‹ˆë‹¤.", voca: { manager: "ê´€ë¦¬ì", proposal: "ì œì•ˆ" } },
            { id: 2, q: "Employees are _______ to attend the workshop.", a: ["require", "required", "requiring", "requirement"], correct: 1, trans: "ì§ì›ë“¤ì€ ì›Œí¬ìˆ ì°¸ì„ì´ ìš”êµ¬ë©ë‹ˆë‹¤.", exp: "ìˆ˜ë™íƒœ ë¬¸ì¥ì…ë‹ˆë‹¤.", voca: { employee: "ì§ì›", attend: "ì°¸ì„í•˜ë‹¤" } },
            { id: 3, q: "The flight was canceled _______ the heavy rain.", a: ["due to", "because", "since", "as"], correct: 0, trans: "í­ìš° ë•Œë¬¸ì— ë¹„í–‰ê¸°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", exp: "ëª…ì‚¬êµ¬ ì• ì „ì¹˜ì‚¬ ìë¦¬ì…ë‹ˆë‹¤.", voca: { flight: "ë¹„í–‰í¸", cancel: "ì·¨ì†Œí•˜ë‹¤" } }
        ];
        const lcBank = [
            { id: 101, q: "Where is the nearest post office?", a: ["At two o'clock.", "Just around the corner.", "By express mail.", "I sent it yesterday."], correct: 1, trans: "ê°€ì¥ ê°€ê¹Œìš´ ìš°ì²´êµ­ì´ ì–´ë””ì¸ê°€ìš”?", exp: "Where ì§ˆë¬¸ì€ ì¥ì†Œë¥¼ ë‹µí•©ë‹ˆë‹¤.", voca: { nearest: "ê°€ì¥ ê°€ê¹Œìš´" } }
        ];

        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let userAnswers = [];
        let currentMode = 'RC';

        window.onload = () => {
            const history = JSON.parse(localStorage.getItem('toeic_history') || '[]');
            const wrongPool = JSON.parse(localStorage.getItem('toeic_wrong_pool') || '[]');
            document.getElementById('stat-info').innerText = `ëˆ„ì  í€´ì¦ˆ: ${history.length}íšŒ | í‰ê·  ì ìˆ˜: ${history.length ? Math.round(history.reduce((a,b)=>a+b.score,0)/history.length) : 0}/5`;
            document.getElementById('wrong-count').innerText = wrongPool.length;
        };

        function startQuiz(mode) {
            currentMode = mode;
            const bank = mode === 'RC' ? rcBank : lcBank;
            currentQuestions = [...bank].sort(() => 0.5 - Math.random()).slice(0, 5);
            setupQuizUI();
        }

        function startWrongMode() {
            const wrongPool = JSON.parse(localStorage.getItem('toeic_wrong_pool') || '[]');
            if (wrongPool.length === 0) return alert("í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!");
            currentMode = 'WRONG';
            currentQuestions = [...wrongPool].sort(() => 0.5 - Math.random()).slice(0, 5);
            setupQuizUI();
        }

        function setupQuizUI() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';
            showQuestion();
        }

        function showQuestion() {
            const qData = currentQuestions[currentIndex];
            document.getElementById('progress-fill').style.width = `${((currentIndex + 1) / currentQuestions.length) * 100}%`;
            
            // LC ëª¨ë“œ í˜¹ì€ ë¬¸ì œì˜ ì¶œì²˜ê°€ LCì¸ ê²½ìš° ì†Œë¦¬ ì¬ìƒ UI ë…¸ì¶œ
            const isLC = currentMode === 'LC' || (currentMode === 'WRONG' && qData.id >= 100);
            document.getElementById('lc-ui').style.display = isLC ? 'block' : 'none';
            document.getElementById('question').innerText = isLC ? "ë¬¸ì œë¥¼ ë“£ê³  ì•Œë§ì€ ë‹µì„ ê³ ë¥´ì„¸ìš”." : qData.q;
            
            if (isLC) playCurrentAudio();

            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            qData.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "btn-option shadow-sm";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(idx);
                optionsDiv.appendChild(btn);
            });
        }

        function playCurrentAudio() {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(currentQuestions[currentIndex].q);
            utterance.lang = 'en-US';
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        function checkAnswer(selected) {
            const qData = currentQuestions[currentIndex];
            const isCorrect = selected === qData.correct;
            
            userAnswers.push(selected);
            if (isCorrect) {
                score++;
                // ë§íˆë©´ ì˜¤ë‹µ í’€ì—ì„œ ì œê±°
                removeFromWrongPool(qData.id);
            } else {
                // í‹€ë¦¬ë©´ ì˜¤ë‹µ í’€ì— ì¶”ê°€
                addToWrongPool(qData);
            }

            currentIndex++;
            if (currentIndex < currentQuestions.length) showQuestion();
            else finishQuiz();
        }

        function addToWrongPool(qData) {
            let pool = JSON.parse(localStorage.getItem('toeic_wrong_pool') || '[]');
            if (!pool.find(item => item.id === qData.id)) {
                pool.push(qData);
                localStorage.setItem('toeic_wrong_pool', JSON.stringify(pool));
            }
        }

        function removeFromWrongPool(qId) {
            let pool = JSON.parse(localStorage.getItem('toeic_wrong_pool') || '[]');
            pool = pool.filter(item => item.id !== qId);
            localStorage.setItem('toeic_wrong_pool', JSON.stringify(pool));
        }

        function finishQuiz() {
            const history = JSON.parse(localStorage.getItem('toeic_history') || '[]');
            history.push({ score: score });
            localStorage.setItem('toeic_history', JSON.stringify(history));
            showResult();
        }

        function showResult() {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('score-text').innerText = `${score} / ${currentQuestions.length}`;
            const reviewSection = document.getElementById('review-section');
            currentQuestions.forEach((q, idx) => {
                const isCorrect = userAnswers[idx] === q.correct;
                reviewSection.innerHTML += `
                    <div class="p-3 mb-3 rounded-4 border ${isCorrect ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10'}">
                        <div class="fw-bold small mb-1">Q: ${q.q}</div>
                        <div class="small mb-1 text-muted">ì •ë‹µ: ${q.a[q.correct]}</div>
                        <div class="small border-top pt-2 mt-2">í•´ì„: ${q.trans}</div>
                    </div>`;
            });
        }

        function resetHistory() {
            if(confirm("ëª¨ë“  ê¸°ë¡ê³¼ ì˜¤ë‹µ ë…¸íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>